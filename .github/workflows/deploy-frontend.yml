name: lugx-frontend CI/CD Flow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  CLUSTER_NAME: lugx-cluster
  CLUSTER_REGION: us-central1
  DEPLOYMENT_NAME: lugx-frontend
  IMAGE: lugx-frontend
  TAG: prod
  REPO_NAME: lugx-repo

jobs:
  deploy-frontend:
    name: Build & Deploy Frontend to Artifact Registry + GKE Autopilot
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v3

      - name: 🔐 Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GKE_SA_KEY }}'

      - name: ⚙️ Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GKE_PROJECT }}

      - name: 🐳 Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: 🏗️ Build Docker Image for Artifact Registry
        run: |
          IMAGE_URI="us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE:$TAG"
          docker build -t $IMAGE_URI .
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: 🚀 Push Docker Image to Artifact Registry
        run: docker push ${{ env.IMAGE_URI }}

      - name: 🔑 Get GKE Cluster Credentials
        run: |
          gcloud container clusters get-credentials "$CLUSTER_NAME" \
            --region "$CLUSTER_REGION" \
            --project "$PROJECT_ID"

      - name: 📥 Install gke-gcloud-auth-plugin
        run: gcloud components install gke-gcloud-auth-plugin --quiet

      - name: 🧪 Debug Cluster Info
        run: kubectl cluster-info

      - name: 📦 Deploy Frontend & Ingress (Skip Validation)
        run: |
          kubectl apply --validate=false -f k8s/frontend-service.yaml
          kubectl apply --validate=false -f k8s/frontend-deployment.yaml
          kubectl apply --validate=false -f k8s/lugx-ingress.yaml
          kubectl rollout restart deployment $DEPLOYMENT_NAME

      - name: ✅ Wait for Rollout to Complete
        run: kubectl rollout status deployment/$DEPLOYMENT_NAME --timeout=180s

      - name: 🔍 Confirm Deployment Status
        run: kubectl get ingress,svc,pods -o wide

      - name: 🐞 Debug Failed Pods (if rollout fails)
        if: failure()
        run: |
          echo "🔍 Describing pods:"
          kubectl describe pods
          echo "📄 Fetching pod logs:"
          kubectl logs -l io.kompose.service=frontend --tail=100 || true
